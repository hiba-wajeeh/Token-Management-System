<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Lab Serving Now</title>

<style>
  :root{
    --pak-green: #065f46;
    --accent: #16a34a;
    --card-bg: #f0fdf4;
  }

  body {
    margin: 0;
    background: #ffffff;
    font-family: "Segoe UI", Arial;
    color: #064e3b;
  }

  .container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 28px 40px;
    gap: 22px;
  }

  .top {
    display: flex;
    align-items: center;
    gap: 22px;
  }

  .logo {
    height: 90px;
  }

  .title {
    font-size: 64px;
    font-weight: 1000;
    letter-spacing: 4px;
    color: var(--pak-green);
  }

  .card {
    margin-top: 40px;
    background: var(--card-bg);
    border: 4px solid var(--accent);
    border-radius: 28px;
    padding: 40px;
    text-align: center;
    min-width: 700px;
  }

  .counter {
    font-size: 38px;
    font-weight: 900;
  }

  .token {
    font-size: 160px;
    font-weight: 1000;
    margin-top: 10px;
  }

  .urdu {
    font-size: 26px;
    font-weight: 700;
    margin-top: 6px;
  }

  .enable-audio {
    margin-top: 20px;
    font-size: 18px;
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    background: var(--accent);
    color: white;
    cursor: pointer;
  }
</style>
</head>

<body>
<div class="container">
  <div class="top">
    <img src="../static/logo.png" class="logo" />
    <div class="title">LAB</div>
  </div>

  <div class="card">
    <div class="counter">LAB</div>
    <div class="token" id="token">—</div>
    <div class="urdu">نرس</div>

    <!-- required once on TVs -->
    <button class="enable-audio" onclick="enableAudio()">Enable Audio</button>
  </div>
</div>

<!-- base audio assets -->
<audio id="ding" src="/static/ding.wav" preload="auto"></audio>
<audio id="intro" src="/static/intro.wav" preload="auto"></audio>
<audio id="nursing" src="/static/nursing.wav" preload="auto"></audio>

<script>
let lastToken = null;
let lastRecallSeq = null;
let audioUnlocked = false;

// ✅ your digit recordings (based on your screenshot)
const DIGIT_FILE = {
  "0": "/static/0.wav",
  "1": "/static/1.wav",
  "2": "/static/2.mp3",
  "3": "/static/3.mp3",
  "4": "/static/4.mp3",
  "5": "/static/5.mp3",
  "6": "/static/6.mp3",
  "7": "/static/7.mp3",
  "8": "/static/8.mp3",
  "9": "/static/9.mp3",
};

// optional: keep cached Audio objects to avoid delay on TVs
const DIGIT_AUDIO = {};
let preloaded = false;

function enableAudio() {
  audioUnlocked = true;
  document.querySelector(".enable-audio").style.display = "none";

  // ✅ Preload digit audios after user gesture (important for TVs)
  if (!preloaded) {
    for (const d of Object.keys(DIGIT_FILE)) {
      const a = new Audio(DIGIT_FILE[d]);
      a.preload = "auto";
      DIGIT_AUDIO[d] = a;
    }
    preloaded = true;
  }

  // "unlock" audio on strict browsers by playing a silent/very short sound
  // If ding.wav is long, do not play it here. We just prime the pipeline.
  try {
    const a = DIGIT_AUDIO["0"] || new Audio(DIGIT_FILE["0"]);
    a.muted = true;
    a.currentTime = 0;
    a.play().then(() => { a.pause(); a.muted = false; }).catch(() => {});
  } catch {}
}

// play a DOM <audio> element and wait until finished
function playAudioEl(audio) {
  return new Promise(res => {
    if (!audioUnlocked) return res();
    audio.currentTime = 0;
    audio.onended = res;
    audio.onerror = res;
    audio.play().catch(() => res());
  });
}

// play a digit audio file (cached) and wait until finished
function playDigit(d) {
  return new Promise(res => {
    if (!audioUnlocked) return res();
    const url = DIGIT_FILE[d];
    if (!url) return res();

    const a = DIGIT_AUDIO[d] || new Audio(url);
    a.currentTime = 0;
    a.onended = res;
    a.onerror = res;

    a.play().catch(() => res());
  });
}

// ✅ uses recordings for digits: 4 → 0 → 2 → 1
async function speakDigits(token) {
  if (!audioUnlocked) return;

  const s = String(token).replace(/\D/g, "");
  for (const d of s) {
    await playDigit(d);
  }
}

// full sequence: ding → intro → digits(recordings) → nursing
async function announce(token) {
  if (!audioUnlocked) return;

  await playAudioEl(document.getElementById("ding"));
  await playAudioEl(document.getElementById("intro"));
  await speakDigits(token);
  await playAudioEl(document.getElementById("nursing"));
}

async function refresh() {
  try {
    const res = await fetch(
      "/api/status?dept=welfare&stage=nursing",
      { cache: "no-store" }
    );
    const data = await res.json();

    const serving = data?.serving || {};
    const token = serving?.Lab1 ?? "—";

    const recallSeq = data?.nursing_recall_seq ?? 0;
    const recallCounter = data?.nursing_recall_counter ?? "Lab1";

    document.getElementById("token").innerText = token;

    // NORMAL CALL
    if (token !== "—" && token !== lastToken) {
      lastToken = token;
      await announce(token);
    }

    // RECALL
    if (
      recallSeq !== lastRecallSeq &&
      recallCounter === "Lab1" &&
      token !== "—"
    ) {
      lastRecallSeq = recallSeq;
      await announce(token);
    }

  } catch (e) {
    console.error(e);
  }
}

refresh();
setInterval(refresh, 1000);
</script>
</body>
</html>